<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla ç§Ÿèµ | ä½“éªŒæœªæ¥</title>

    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <style>
        :root {
            --apple-bg: #f5f5f7;
            --apple-card-bg: #ffffff;
            --apple-text-primary: #1d1d1f;
            --apple-text-secondary: #86868b;
            --apple-blue: #0071e3;
            --apple-blue-hover: #0077ed;
            --apple-border: #d2d2d7;
            --apple-radius: 20px;
            --apple-shadow: 0 8px 30px rgba(0, 0, 0, 0.04);
            --apple-header-bg: rgba(255, 255, 255, 0.7);
        }

        body {
            background-color: var(--apple-bg);
            color: var(--apple-text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Navbar --- */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--apple-header-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding: 0 20px;
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            height: 52px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 20px;
            font-weight: 600;
            color: var(--apple-text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-link {
            color: var(--apple-text-secondary);
            text-decoration: none;
            font-size: 12px;
            margin-left: 24px;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: var(--apple-text-primary);
        }

        /* --- Hero Section --- */
        .hero {
            text-align: center;
            padding: 120px 20px 80px;
            background: #fff;
            margin-bottom: 40px;
        }

        .hero-title {
            font-size: 56px;
            font-weight: 700;
            line-height: 1.07143;
            letter-spacing: -0.005em;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #000, #333);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            font-size: 24px;
            line-height: 1.16667;
            font-weight: 400;
            letter-spacing: .009em;
            color: var(--apple-text-secondary);
            margin-bottom: 40px;
        }

        /* --- Vehicle Grid --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px 80px;
            flex: 1;
        }

        .section-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 40px;
            text-align: center;
        }

        /* --- è½¦å‹åˆ†ç±»èœå• --- */
        .model-menu {
            display: flex;
            gap: 16px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .model-btn {
            padding: 12px 28px;
            border: 2px solid var(--apple-border);
            background: white;
            border-radius: 980px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--apple-text-primary);
            transition: all 0.3s ease;
        }

        .model-btn:hover {
            border-color: var(--apple-blue);
            color: var(--apple-blue);
        }

        .model-btn.active {
            background: var(--apple-blue);
            color: white;
            border-color: var(--apple-blue);
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
        }

        .vehicle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
        }

        .vehicle-card {
            background: var(--apple-card-bg);
            border-radius: var(--apple-radius);
            overflow: hidden;
            box-shadow: var(--apple-shadow);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0, 0, 0, 0.02);
        }

        .vehicle-card:hover {
            transform: scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .vehicle-image {
            height: 200px;
            background-color: #f5f5f7;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .vehicle-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .vehicle-info {
            padding: 24px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .vehicle-model {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--apple-text-primary);
        }

        .vehicle-price {
            font-size: 16px;
            color: var(--apple-text-secondary);
            margin-bottom: 20px;
        }

        .vehicle-price span {
            color: var(--apple-text-primary);
            font-weight: 600;
            font-size: 20px;
        }

        .book-btn {
            margin-top: auto;
            width: 100%;
            background: var(--apple-blue);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 980px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .book-btn:hover {
            background: var(--apple-blue-hover);
        }

        /* --- Footer --- */
        .footer {
            background: #f5f5f7;
            padding: 40px 20px;
            text-align: center;
            font-size: 12px;
            color: var(--apple-text-secondary);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* --- Element Plus Overrides --- */
        .el-dialog {
            border-radius: var(--apple-radius) !important;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.2) !important;
        }

        .el-button--primary {
            background-color: var(--apple-blue) !important;
            border-color: var(--apple-blue) !important;
            border-radius: 980px !important;
        }

        .el-input__wrapper {
            border-radius: 12px !important;
            box-shadow: 0 0 0 1px #d2d2d7 inset !important;
        }

        .el-input__wrapper.is-focus {
            box-shadow: 0 0 0 1px var(--apple-blue) inset !important;
        }

        /* --- AI Chat Widget --- */
        .chat-widget-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--apple-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 113, 227, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-size: 24px;
        }

        .chat-widget-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(0, 113, 227, 0.6);
        }

        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 380px;
            height: 500px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 24px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transform-origin: bottom right;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.5);
        }

        .chat-title {
            font-weight: 600;
            font-size: 16px;
        }

        .chat-close {
            cursor: pointer;
            color: var(--apple-text-secondary);
            font-size: 20px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 80%;
            padding: 10px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user {
            align-self: flex-end;
            background: var(--apple-blue);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.ai {
            align-self: flex-start;
            background: #e5e5ea;
            color: black;
            border-bottom-left-radius: 4px;
        }

        .chat-input-area {
            padding: 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.5);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            border: none;
            background: #f5f5f5;
            padding: 10px 16px;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }

        .chat-input:focus {
            background: #eaeaea;
        }

        /* Transition for chat window */
        .fade-slide-enter-active,
        .fade-slide-leave-active {
            transition: all 0.3s ease;
        }

        .fade-slide-enter-from,
        .fade-slide-leave-to {
            opacity: 0;
            transform: translateY(20px) scale(0.9);
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-content">
                <a href="#" class="logo">ï£¿ Tesla ç§Ÿèµ</a>
                <div>
                    <a href="#" class="nav-link" @click="dialogVisible = false; currentFilter='ALL'">è½¦å‹</a>
                    <a href="#" class="nav-link" @click="openMyOrders">æˆ‘çš„è®¢å•</a>
                </div>
            </div>
        </nav>

        <!-- Hero -->
        <header class="hero">
            <h1 class="hero-title">ä½“éªŒæœªæ¥ï¼Œå³åˆ»å‡ºå‘</h1>
            <p class="hero-subtitle">é€‰æ‹©æ‚¨å¿ƒä»ªçš„ Teslaï¼Œå¼€å¯éå‡¡æ—…ç¨‹ã€‚</p>
        </header>

        <!-- Vehicle Grid -->
        <main class="container">
            <h2 class="section-title">é€‰æ‹©æ‚¨çš„åº§é©¾</h2>

            <!-- è½¦å‹åˆ†ç±»èœå• -->
            <div class="model-menu">
                <button class="model-btn" :class="{ active: currentFilter === 'ALL' }" @click="currentFilter = 'ALL'">
                    å…¨éƒ¨è½¦å‹
                </button>
                <button v-if="aiRecommendedModels.length > 0" class="model-btn"
                    :class="{ active: currentFilter === 'AI' }" @click="currentFilter = 'AI'">
                    AI æ¨è
                </button>
                <button class="model-btn" :class="{ active: currentFilter === model }" v-for="model in availableModels"
                    :key="model" @click="currentFilter = model">
                    {{ model }}
                </button>
            </div>

            <div class="vehicle-grid" v-loading="loading">
                <div class="vehicle-card" v-for="vehicle in filteredVehicles" :key="vehicle.vehicleId">
                    <div class="vehicle-image">
                        <img :src="getCarImage(vehicle.carModelName)" :alt="vehicle.carModelName">
                    </div>
                    <div class="vehicle-info">
                        <div class="vehicle-model">{{ vehicle.carModelName }}</div>
                        <div class="vehicle-price">è½¦ç‰Œå· <span>{{ vehicle.plateNo }}</span></div>
                        <div class="vehicle-price" style="font-size: 12px; margin-top: 8px;">
                            <span style="color: var(--apple-text-secondary);">ç”µé‡: {{ vehicle.currentSoc }}% | é‡Œç¨‹: {{
                                vehicle.currentMileage }}km</span>
                        </div>
                        <button class="book-btn" @click="openBooking(vehicle)">ç«‹å³é¢„è®¢</button>
                    </div>
                </div>
            </div>

            <div v-if="!loading && filteredVehicles.length === 0"
                style="text-align: center; color: var(--apple-text-secondary); padding: 40px;">
                æš‚æ— å¯ç”¨è½¦è¾†
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            Copyright Â© 2025 Tesla Rental Inc. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚
        </footer>

        <!-- Booking Dialog -->
        <el-dialog v-model="dialogVisible" title="é¢„è®¢è½¦è¾†" width="400px" align-center>
            <div v-if="selectedVehicle" style="margin-bottom: 20px; text-align: center;">
                <h3 style="margin: 0;">{{ selectedVehicle.model }}</h3>
                <p style="color: var(--apple-text-secondary); margin: 5px 0;">{{ selectedVehicle.plateNo }}</p>
            </div>

            <el-form :model="form" label-position="top">
                <el-form-item label="æ‚¨çš„å§“å">
                    <el-input v-model="form.name" placeholder="è¯·è¾“å…¥å§“å"></el-input>
                </el-form-item>
                <el-form-item label="è”ç³»ç”µè¯">
                    <el-input v-model="form.phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·"></el-input>
                </el-form-item>
                <el-form-item label="èº«ä»½è¯å·">
                    <el-input v-model="form.idCard" placeholder="è¯·è¾“å…¥èº«ä»½è¯å·"></el-input>
                </el-form-item>
                <el-form-item label="é©¾ç…§å·">
                    <el-input v-model="form.driverLicense" placeholder="è¯·è¾“å…¥é©¾ç…§å·"></el-input>
                </el-form-item>
                <el-form-item label="ç§ŸæœŸ">
                    <el-date-picker v-model="dateRange" type="datetimerange" range-separator="è‡³"
                        start-placeholder="å¼€å§‹æ—¶é—´" end-placeholder="ç»“æŸæ—¶é—´" style="width: 100%" />
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="submitBooking" :loading="submitting">ç¡®è®¤é¢„è®¢</el-button>
            </template>
            <template #footer>
                <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="submitBooking" :loading="submitting">ç¡®è®¤é¢„è®¢</el-button>
            </template>
        </el-dialog>

        <!-- My Orders Dialog -->
        <el-dialog v-model="myOrdersVisible" title="æˆ‘çš„è®¢å•" width="1000px" align-center>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <el-input v-model="myOrdersPhone" placeholder="è¯·è¾“å…¥é¢„è®¢æ—¶çš„æ‰‹æœºå·ç " style="flex: 1"
                    @keyup.enter="searchMyOrders"></el-input>
                <el-button type="primary" @click="searchMyOrders" :loading="searchingMyOrders">æŸ¥è¯¢</el-button>
            </div>
            <div style="margin: -10px 0 12px; color: #909399; font-size: 12px;">
                æç¤ºï¼šåœ¨â€œä½¿ç”¨ä¸­/å¾…éªŒè½¦â€è®¢å•å³ä¾§ç‚¹å‡»â€œæŠ¥æ•…éšœâ€å³å¯æäº¤å·¥å•ã€‚
            </div>

            <el-table :data="myOrdersList" style="width: 100%" empty-text="è¯·è¾“å…¥æ‰‹æœºå·æŸ¥è¯¢æˆ–æš‚æ— è®¢å•">
                <el-table-column prop="vehicleName" label="è½¦è¾†" width="120"></el-table-column>
                <el-table-column prop="plateNo" label="è½¦ç‰Œå·" width="100"></el-table-column>
                <el-table-column label="çŠ¶æ€" align="center" width="100">
                    <template #default="scope">
                        <el-tag :type="
                            scope.row.status === 'å·²æ”¯ä»˜' ? 'info' : 
                            scope.row.status === 'ä½¿ç”¨ä¸­' ? 'success' : 
                            scope.row.status === 'å¾…éªŒè½¦' ? 'warning' : 'info'" effect="light">
                            {{ scope.row.status }}
                        </el-tag>
                    </template>
                </el-table-column>
                <el-table-column label="æ•…éšœå·¥å•" width="120" align="center">
                    <template #default="scope">
                        <el-tag v-if="scope.row.faultStatus"
                            :type="scope.row.faultStatus === 'å¾…è§£å†³' ? 'danger' : 'success'">
                            {{ scope.row.faultStatus }}
                        </el-tag>
                        <span v-else style="color: #909399;">æ— </span>
                    </template>
                </el-table-column>
                <el-table-column prop="rentStart" label="èµ·ç§Ÿæ—¶é—´" width="160"></el-table-column>
                <el-table-column prop="rentEnd" label="è¿˜è½¦æ—¶é—´" width="160"></el-table-column>
                <el-table-column label="æ“ä½œ" align="center" min-width="220">
                    <template #default="scope">
                        <el-button v-if="scope.row.status === 'ä½¿ç”¨ä¸­'" type="primary" size="small"
                            @click="applyReturn(scope.row.orderId)">ç”³è¯·è¿˜è½¦</el-button>
                        <el-button v-if="(scope.row.status === 'ä½¿ç”¨ä¸­' || scope.row.status === 'å¾…éªŒè½¦')" type="danger"
                            size="small" :disabled="scope.row.faultStatus === 'å¾…è§£å†³'"
                            @click="openFaultDialog(scope.row)">æŠ¥æ•…éšœ</el-button>
                        <span v-else-if="scope.row.status === 'å·²æ”¯ä»˜'" style="color: #999; font-size: 12px;">ç­‰å¾…å–è½¦</span>
                        <span v-else-if="scope.row.status === 'å¾…éªŒè½¦'"
                            style="color: #e6a23c; font-size: 12px;">è¯·å‰å¾€é—¨åº—éªŒè½¦</span>
                        <span v-else-if="scope.row.status === 'å·²å®Œæˆ'"
                            style="color: #67c23a; font-size: 12px;">è®¢å•å·²ç»“æŸ</span>
                    </template>
                </el-table-column>
            </el-table>
        </el-dialog>

        <!-- æ•…éšœæŠ¥ä¿® -->
        <el-dialog v-model="faultDialogVisible" title="è½¦è¾†æ•…éšœæŠ¥ä¿®" width="500px" align-center>
            <el-form :model="faultForm" label-position="top">
                <el-form-item label="è®¢å• ID">
                    <el-input v-model="faultForm.orderId" disabled></el-input>
                </el-form-item>
                <el-form-item label="è½¦è¾† ID">
                    <el-input v-model="faultForm.vehicleId" disabled></el-input>
                </el-form-item>
                <el-form-item label="æ•…éšœæè¿°">
                    <el-input type="textarea" v-model="faultForm.description" placeholder="è¯·æè¿°å‘ç°çš„æ•…éšœç°è±¡"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="faultDialogVisible = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="submitFault" :loading="faultSubmitting">æäº¤å·¥å•</el-button>
            </template>
        </el-dialog>

        <!-- Chat Widget -->
        <div class="chat-widget-btn" @click="toggleChat">
            <span v-if="!chatVisible">ğŸ’¬</span>
            <span v-else>âœ•</span>
        </div>

        <transition name="fade-slide">
            <div class="chat-window" v-if="chatVisible">
                <div class="chat-header">
                    <div class="chat-title">Tesla é€‰è½¦é¡¾é—® ğŸ¤–</div>
                    <div class="chat-close" @click="chatVisible = false">âœ•</div>
                </div>
                <div class="chat-messages" ref="chatMessagesRef">
                    <div v-for="(msg, index) in chatMessages" :key="index" class="message"
                        :class="msg.role === 'user' ? 'user' : 'ai'">
                        {{ msg.content }}
                    </div>
                    <div v-if="chatLoading" class="message ai">æ­£åœ¨å›å¤...</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" v-model="chatInput" @keyup.enter="sendMessage"
                        placeholder="æˆ‘æƒ³ç§Ÿä¸€è¾†å®¶åº­å‡ºæ¸¸çš„è½¦..." :disabled="chatLoading">
                    <el-button type="primary" circle size="small" @click="sendMessage" :loading="chatLoading">
                        â†‘
                    </el-button>
                </div>
            </div>
        </transition>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;

        const app = createApp({
            setup() {
                const loading = ref(false);
                const submitting = ref(false);
                const vehicles = ref([]);
                // const selectedModel = ref(null); // Replaced by currentFilter
                const currentFilter = ref('ALL'); // 'ALL', 'AI', or specific model name
                const aiRecommendedModels = ref([]);

                const dialogVisible = ref(false);
                const selectedVehicle = ref(null);
                const dateRange = ref([]);
                const stores = ref([]);

                // Chat State
                const chatVisible = ref(false);
                const chatInput = ref('');
                const chatLoading = ref(false);
                const chatMessages = ref([
                    { role: 'ai', content: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ Tesla é€‰è½¦åŠ©æ‰‹ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨çš„éœ€æ±‚ï¼ˆä¾‹å¦‚ï¼šå®¶åº­ç”¨è½¦ã€è¿½æ±‚é€Ÿåº¦ã€æ€§ä»·æ¯”é«˜ï¼‰ï¼Œæˆ‘æ¥ä¸ºæ‚¨æ¨èã€‚' }
                ]);
                const chatMessagesRef = ref(null);

                const form = reactive({
                    name: '',
                    phone: '',
                    idCard: '',
                    driverLicense: ''
                });

                // My Orders State
                const myOrdersVisible = ref(false);
                const myOrdersPhone = ref('');
                const myOrdersList = ref([]);
                const searchingMyOrders = ref(false);
                const currentCustomerId = ref(null);

                // æ•…éšœæŠ¥ä¿®
                const faultDialogVisible = ref(false);
                const faultSubmitting = ref(false);
                const faultForm = reactive({
                    orderId: null,
                    vehicleId: null,
                    customerId: null,
                    description: ''
                });
                const faultTickets = ref([]);

                const baseUrl = 'http://localhost:8080/api';

                // Chat Logic
                const toggleChat = () => {
                    chatVisible.value = !chatVisible.value;
                    if (chatVisible.value) {
                        setTimeout(scrollToBottom, 100);
                    }
                };

                const scrollToBottom = () => {
                    if (chatMessagesRef.value) {
                        chatMessagesRef.value.scrollTop = chatMessagesRef.value.scrollHeight;
                    }
                };

                const sendMessage = async () => {
                    if (!chatInput.value.trim()) return;

                    const userMsg = chatInput.value;
                    chatMessages.value.push({ role: 'user', content: userMsg });
                    chatInput.value = '';
                    chatLoading.value = true;
                    scrollToBottom();

                    try {
                        const response = await axios.post(`${baseUrl}/ai/chat`, {
                            message: userMsg
                        });

                        const data = response.data;
                        chatMessages.value.push({ role: 'ai', content: data.reply });

                        // è‡ªåŠ¨ç­›é€‰é€»è¾‘
                        if (data.recommendedModels && data.recommendedModels.length > 0) {
                            aiRecommendedModels.value = data.recommendedModels;
                            currentFilter.value = 'AI';

                            const modelsStr = data.recommendedModels.join(', ');
                            ElementPlus.ElMessage.success(`å·²ä¸ºæ‚¨åˆ‡æ¢è‡³ "AI æ¨è"ï¼š${modelsStr}`);

                            // æ»šåŠ¨åˆ°è½¦è¾†åˆ—è¡¨
                            document.querySelector('.vehicle-grid').scrollIntoView({ behavior: 'smooth' });
                        }

                    } catch (error) {
                        console.error("AI Chat Error", error);
                        chatMessages.value.push({ role: 'ai', content: 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•è¿æ¥åˆ°å¤§è„‘ï¼Œè¯·ç¨åå†è¯•ã€‚' });
                    } finally {
                        chatLoading.value = false;
                        setTimeout(scrollToBottom, 100);
                    }
                };

                // æ¨¡æ‹Ÿæ•°æ®ï¼Œé˜²æ­¢åç«¯æœªå¯åŠ¨æ—¶é¡µé¢ç©ºç™½
                const mockVehicles = [
                    { vehicleId: 1, carModelName: 'Model 3', plateNo: 'äº¬A 88888', currentSoc: 92, currentMileage: 1240, status: 'åœ¨åº“' },
                    { vehicleId: 2, carModelName: 'Model Y', plateNo: 'æ²ªB 66666', currentSoc: 88, currentMileage: 3456, status: 'åœ¨åº“' },
                    { vehicleId: 3, carModelName: 'Model S', plateNo: 'ç²¤Z 99999', currentSoc: 95, currentMileage: 2100, status: 'åœ¨åº“' },
                    { vehicleId: 4, carModelName: 'Model X', plateNo: 'å·A 77777', currentSoc: 85, currentMileage: 5230, status: 'åœ¨åº“' },
                    { vehicleId: 5, carModelName: 'Model 3', plateNo: 'æµ™A 55555', currentSoc: 90, currentMileage: 1800, status: 'åœ¨åº“' }
                ];

                const fetchVehicles = async () => {
                    loading.value = true;
                    try {
                        const response = await axios.get(`${baseUrl}/vehicles`);
                        vehicles.value = response.data || [];
                    } catch (error) {
                        console.log("ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®");
                        vehicles.value = mockVehicles;
                    } finally {
                        loading.value = false;
                    }
                };

                const fetchStores = async () => {
                    try {
                        const response = await axios.get(`${baseUrl}/stores`);
                        stores.value = response.data || [];
                    } catch (error) {
                        console.error("è·å–é—¨åº—å¤±è´¥", error);
                    }
                };

                // æå–è½¦å‹ï¼ˆä»carModelNameå­—æ®µä¸­ï¼‰
                const availableModels = computed(() => {
                    const models = new Set();
                    vehicles.value.forEach(v => {
                        if (v.carModelName) {
                            models.add(v.carModelName);
                        }
                    });
                    return Array.from(models).sort();
                });

                // è¿‡æ»¤è½¦è¾†ï¼šå…ˆè¿‡æ»¤åœ¨åº“çŠ¶æ€ï¼Œå†æŒ‰ currentFilter è¿‡æ»¤
                const filteredVehicles = computed(() => {
                    let result = vehicles.value.filter(v => v.status === 'åœ¨åº“');

                    if (currentFilter.value === 'ALL') {
                        // Do nothing, show all
                    } else if (currentFilter.value === 'AI') {
                        // è¿‡æ»¤å‡ºåœ¨æ¨èåˆ—è¡¨ä¸­çš„è½¦å‹
                        result = result.filter(v => aiRecommendedModels.value.includes(v.carModelName));
                    } else {
                        // å…·ä½“è½¦å‹
                        result = result.filter(v => v.carModelName === currentFilter.value);
                    }

                    return result;
                });

                const openBooking = (vehicle) => {
                    selectedVehicle.value = vehicle;
                    dialogVisible.value = true;
                };

                const submitBooking = async () => {
                    if (!form.name || !form.phone || !form.idCard || !form.driverLicense || !dateRange.value || dateRange.value.length < 2) {
                        ElementPlus.ElMessage.warning('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                        return;
                    }

                    submitting.value = true;
                    try {
                        // 1. åˆ›å»ºæˆ–è·å–å®¢æˆ·
                        let customerId;
                        try {
                            const customerRes = await axios.post(`${baseUrl}/customers`, {
                                name: form.name,
                                phone: form.phone,
                                idCard: form.idCard,
                                driverLicense: form.driverLicense
                            });
                            customerId = customerRes.data.customerId || customerRes.data.id;
                        } catch (e) {
                            console.error('ä¿å­˜å®¢æˆ·ä¿¡æ¯å¤±è´¥', e);
                            ElementPlus.ElMessage.error('æ— æ³•ä¿å­˜å®¢æˆ·ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•');
                            submitting.value = false;
                            return;
                        }

                        // 2. åˆ›å»ºè®¢å•ï¼ˆåç«¯ä¼šè‡ªåŠ¨æ›´æ–°è½¦è¾†çŠ¶æ€ä¸º"åœ¨ç§Ÿ")
                        // åç«¯ RentalOrder.rentStart/rentEnd ä¸º LocalDateTime ä¸¥æ ¼æ ¼å¼ yyyy-MM-dd HH:mm:ss
                        // å‰ç«¯çš„ Element Plus datetime range è¿”å› JS Date -> éœ€è¦æ ¼å¼åŒ–ä¸ºåç«¯èƒ½è§£æçš„å­—ç¬¦ä¸²
                        const vehicleId = selectedVehicle.value.vehicleId || selectedVehicle.value.id;

                        const formatDateTime = (d) => {
                            if (!d) return null;
                            const dt = new Date(d);
                            const pad = (n) => String(n).padStart(2, '0');
                            const yyyy = dt.getFullYear();
                            const MM = pad(dt.getMonth() + 1);
                            const dd = pad(dt.getDate());
                            const hh = pad(dt.getHours());
                            const mm = pad(dt.getMinutes());
                            const ss = pad(dt.getSeconds());
                            return `${yyyy}-${MM}-${dd} ${hh}:${mm}:${ss}`;
                        };

                        await axios.post(`${baseUrl}/orders`, {
                            customerId: customerId,
                            vehicleId: vehicleId,
                            rentStart: formatDateTime(dateRange.value[0]),
                            rentEnd: formatDateTime(dateRange.value[1]),
                            pickupSoc: 100,
                            returnSoc: 100,
                            pickupSoc: 100,
                            returnSoc: 100,
                            pickupStoreId: stores.value.length > 0 ? stores.value[0].storeId : 1,
                            returnStoreId: stores.value.length > 0 ? stores.value[0].storeId : 1,
                            totalAmount: 0,
                            totalAmount: 0,
                            status: 'å·²æ”¯ä»˜'
                        });

                        ElementPlus.ElMessage.success('é¢„è®¢æˆåŠŸï¼æˆ‘ä»¬ä¼šå°½å¿«è”ç³»æ‚¨ã€‚');
                        dialogVisible.value = false;

                        // 3. é‡æ–°è·å–è½¦è¾†åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€
                        await fetchVehicles();

                        // æ¸…ç©ºè¡¨å•
                        form.name = '';
                        form.phone = '';
                        form.idCard = '';
                        form.driverLicense = '';
                        dateRange.value = [];

                    } catch (error) {
                        console.error('é¢„è®¢å¤±è´¥:', error);
                        ElementPlus.ElMessage.error('é¢„è®¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    } finally {
                        submitting.value = false;
                    }
                };

                // æ ¹æ®è½¦å‹åç§°è·å–å¯¹åº”çš„å›¾ç‰‡
                const getCarImage = (modelName) => {
                    const imageMap = {
                        'Model 3': '/images/model3.png',
                        'Model Y': '/images/modely.png',
                        'Model S': '/images/models.png',
                        'Model X': '/images/modelx.png',
                        'Cybertruck': '/images/cybertruck.png'
                    };
                    return imageMap[modelName] || '/images/model3.png';
                };

                // ç”³è¯·è¿˜è½¦
                const applyReturn = async (orderId) => {
                    if (!confirm('ç¡®è®¤ç”³è¯·è¿˜è½¦å—ï¼Ÿè¯·ç¡®ä¿å·²å°†è½¦è¾†å¼€å›é—¨åº—ã€‚')) {
                        return;
                    }

                    try {
                        const res = await axios.put(`${baseUrl}/orders/${orderId}/apply-return`);
                        ElementPlus.ElMessage.success('è¿˜è½¦ç”³è¯·å·²æäº¤ï¼è¯·å‰å¾€é—¨åº—è¿›è¡ŒéªŒè½¦ã€‚');
                        // åˆ·æ–°è®¢å•åˆ—è¡¨
                        searchMyOrders();
                    } catch (error) {
                        console.error(error);
                        ElementPlus.ElMessage.error('ç”³è¯·å¤±è´¥: ' + (error.response?.data?.message || error.message));
                    }
                };

                // æŠ¥æ•…éšœ
                const openFaultDialog = (order) => {
                    faultForm.orderId = order.orderId;
                    faultForm.vehicleId = order.currentVehicleId || order.vehicleId;
                    faultForm.customerId = order.customerId || currentCustomerId.value;
                    faultForm.description = '';
                    faultDialogVisible.value = true;
                };

                const submitFault = async () => {
                    if (!faultForm.description) {
                        ElementPlus.ElMessage.warning('è¯·å¡«å†™æ•…éšœæè¿°');
                        return;
                    }
                    faultSubmitting.value = true;
                    try {
                        await axios.post(`${baseUrl}/faults`, faultForm);
                        ElementPlus.ElMessage.success('å·²æäº¤æ•…éšœå·¥å•ï¼Œå·¥ä½œäººå‘˜å°†å°½å¿«å¤„ç†');
                        faultDialogVisible.value = false;
                        searchMyOrders();
                    } catch (error) {
                        console.error(error);
                        ElementPlus.ElMessage.error('æäº¤å¤±è´¥: ' + (error.response?.data?.message || error.message));
                    } finally {
                        faultSubmitting.value = false;
                    }
                };

                // My Orders Logic
                const openMyOrders = () => {
                    myOrdersVisible.value = true;
                    // å¦‚æœå·²ç»æœ‰æ‰‹æœºå·ï¼ˆæ¯”å¦‚åˆšä¸‹è¿‡å•ï¼‰ï¼Œè‡ªåŠ¨å¡«å……
                    if (form.phone) {
                        myOrdersPhone.value = form.phone;
                    }
                };

                const searchMyOrders = async () => {
                    if (!myOrdersPhone.value) {
                        ElementPlus.ElMessage.warning('è¯·è¾“å…¥æ‰‹æœºå·ç ');
                        return;
                    }

                    searchingMyOrders.value = true;
                    myOrdersList.value = [];

                    try {
                        // 1. è·å–æ‰€æœ‰å®¢æˆ·æ‰¾åˆ°å¯¹åº”ID
                        // (ä¼˜åŒ–æ–¹æ¡ˆï¼šåç«¯æä¾›æŒ‰æ‰‹æœºå·æŸ¥ç”¨æˆ·çš„æ¥å£ï¼Œä½†è¿™é‡Œä¸ºäº†æœ€å°‘æ”¹åŠ¨ä½¿ç”¨å…¨é‡è¿‡æ»¤)
                        const customersRes = await axios.get(`${baseUrl}/customers`);
                        const customer = customersRes.data.find(c => c.phone === myOrdersPhone.value);

                        if (!customer) {
                            ElementPlus.ElMessage.info('æœªæ‰¾åˆ°è¯¥æ‰‹æœºå·çš„è®°å½•');
                            return;
                        }

                        // 2. è·å–æ‰€æœ‰è®¢å•è¿‡æ»¤è¯¥å®¢æˆ·çš„è®¢å•
                        // (åŒæ ·ï¼Œå®é™…ç”Ÿäº§ä¸­åº”ä½¿ç”¨åç«¯æŸ¥è¯¢å‚æ•° /api/orders?customerId=...)
                        const ordersRes = await axios.get(`${baseUrl}/orders`);
                        const myOrders = ordersRes.data.filter(o => o.customerId === customer.customerId);
                        currentCustomerId.value = customer.customerId;

                        // 3. ä¸°å¯Œè®¢å•ä¿¡æ¯ï¼ˆè½¦è¾†ä¿¡æ¯ + æ•…éšœå·¥å•ï¼‰
                        const vehiclesRes = await axios.get(`${baseUrl}/vehicles`);
                        const modelsRes = await axios.get(`${baseUrl}/models`); // è·å–è½¦å‹åç§°
                        const faultsRes = await axios.get(`${baseUrl}/faults`);
                        faultTickets.value = faultsRes.data || [];

                        const faultByOrder = {};
                        faultTickets.value.forEach(t => {
                            if (!t.orderId) return;
                            const existing = faultByOrder[t.orderId];
                            if (!existing || (t.reportedTime && (!existing?.reportedTime || t.reportedTime > existing.reportedTime))) {
                                faultByOrder[t.orderId] = t;
                            }
                        });

                        const enrichedOrders = myOrders.map(order => {
                            const vehicleIdForDisplay = order.currentVehicleId || order.vehicleId;
                            const vehicle = vehiclesRes.data.find(v => v.vehicleId === vehicleIdForDisplay);
                            const modelName = vehicle ? (vehicle.carModelName || 'Unknown Model') : 'æœªçŸ¥è½¦è¾†';
                            const fault = faultByOrder[order.orderId];

                            return {
                                ...order,
                                vehicleName: modelName,
                                plateNo: vehicle ? vehicle.plateNo : '---',
                                status: order.status, // å‡è®¾åç«¯è¿”å›çš„æ˜¯ä¸­æ–‡ label æˆ–è€… æšä¸¾åã€‚RentalOrderStatus JSON valueæ˜¯label
                                faultStatus: fault ? fault.status : null,
                                faultTicketId: fault ? fault.ticketId : null
                            };
                        });

                        // æŒ‰æ—¶é—´å€’åº
                        enrichedOrders.sort((a, b) => new Date(b.rentStart) - new Date(a.rentStart));

                        myOrdersList.value = enrichedOrders;

                    } catch (e) {
                        console.error("æŸ¥è¯¢è®¢å•å¤±è´¥", e);
                        ElementPlus.ElMessage.error('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
                    } finally {
                        searchingMyOrders.value = false;
                    }
                };

                onMounted(() => {
                    fetchVehicles();
                    fetchStores();
                });

                return {
                    loading,
                    submitting,
                    vehicles,
                    // selectedModel, // Removed
                    currentFilter, // Added
                    aiRecommendedModels, // Added
                    availableModels,
                    filteredVehicles,
                    dialogVisible,
                    selectedVehicle,
                    form,
                    dateRange,
                    openBooking,
                    submitBooking,
                    fetchVehicles,
                    getCarImage,
                    // My Orders
                    myOrdersVisible,
                    myOrdersPhone,
                    myOrdersList,
                    searchingMyOrders,
                    openMyOrders,
                    searchMyOrders,
                    applyReturn,
                    faultDialogVisible,
                    faultForm,
                    faultSubmitting,
                    openFaultDialog,
                    submitFault,
                    // Chat
                    chatVisible,
                    chatInput,
                    chatLoading,
                    chatMessages,
                    chatMessagesRef,
                    toggleChat,
                    sendMessage
                };
            }
        });

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>

</html>
