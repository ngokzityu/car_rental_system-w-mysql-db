# Tesla ç§Ÿè½¦ç³»ç»Ÿ - Java è°ƒç”¨ç¤ºä¾‹æ–‡æ¡£

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2025-12-08  
**è¯´æ˜**: è¯¾ç¨‹è®¾è®¡ 3.5.9 åº”ç”¨ç³»ç»Ÿè®¾è®¡ - Java è°ƒç”¨ç¤ºä¾‹ä¸è§’è‰²æƒé™è¯´æ˜

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [Repository å±‚è°ƒç”¨ç¤ºä¾‹](#repository-å±‚è°ƒç”¨ç¤ºä¾‹)
4. [Controller å±‚è°ƒç”¨ç¤ºä¾‹](#controller-å±‚è°ƒç”¨ç¤ºä¾‹)
5. [è§’è‰²æƒé™æ˜ å°„](#è§’è‰²æƒé™æ˜ å°„)
6. [å®‰å…¨é…ç½®ç¤ºä¾‹](#å®‰å…¨é…ç½®ç¤ºä¾‹)
7. [æµ‹è¯•éªŒæ”¶](#æµ‹è¯•éªŒæ”¶)

---

## ğŸ“– æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨ Spring Boot åº”ç”¨ä¸­è°ƒç”¨ï¼š
- âœ… **3.5.2 ä¸šåŠ¡æŸ¥è¯¢**ï¼šåŸç”Ÿ SQL æŸ¥è¯¢
- âœ… **3.5.4 ä¸šåŠ¡è§†å›¾**ï¼š7ä¸ªè§†å›¾çš„æŸ¥è¯¢
- âœ… **3.5.6 å­˜å‚¨è¿‡ç¨‹**ï¼š7ä¸ªå­˜å‚¨è¿‡ç¨‹çš„è°ƒç”¨

åŒæ—¶è¯´æ˜ **admin/staff/auditor** ä¸‰ç§è§’è‰²çš„æƒé™æ˜ å°„å’Œè®¿é—®æ§åˆ¶ã€‚

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

### Java åŒ…ç»“æ„

```
src/main/java/com/tesla/rental/
â”œâ”€â”€ controller/                  # REST API æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ RentalOrderController.java
â”‚   â”œâ”€â”€ VehicleController.java
â”‚   â”œâ”€â”€ CustomerController.java
â”‚   â”œâ”€â”€ PaymentController.java
â”‚   â”œâ”€â”€ MaintenanceController.java
â”‚   â”œâ”€â”€ ViolationController.java
â”‚   â”œâ”€â”€ CarModelController.java
â”‚   â”œâ”€â”€ StoreController.java
â”‚   â””â”€â”€ AuthController.java
â”‚
â”œâ”€â”€ repository/                  # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ RentalOrderRepository.java
â”‚   â”œâ”€â”€ VehicleRepository.java
â”‚   â”œâ”€â”€ CustomerRepository.java
â”‚   â”œâ”€â”€ PaymentRepository.java
â”‚   â”œâ”€â”€ MaintenanceRepository.java
â”‚   â”œâ”€â”€ ViolationRepository.java
â”‚   â”œâ”€â”€ CarModelRepository.java
â”‚   â”œâ”€â”€ StoreRepository.java
â”‚   â”œâ”€â”€ BrandRepository.java
â”‚   â”œâ”€â”€ SysUserRepository.java
â”‚   â”œâ”€â”€ SysRoleRepository.java
â”‚   â””â”€â”€ SysUserRoleRepository.java
â”‚
â”œâ”€â”€ entity/                      # å®ä½“ç±»
â”œâ”€â”€ dto/                         # æ•°æ®ä¼ è¾“å¯¹è±¡
â””â”€â”€ security/                    # å®‰å…¨é…ç½®
    â””â”€â”€ CustomUserDetailsService.java
```

### æ•°æ®åº“è„šæœ¬å¯¹åº”å…³ç³»

| è„šæœ¬æ–‡ä»¶ | Java è°ƒç”¨æ–¹å¼ | å¯¹åº”ç±» |
|---------|--------------|--------|
| `3.5.2_queries.sql` | åŸç”ŸæŸ¥è¯¢/JPQL | Repository + @Query |
| `3.5.4_views.sql` | JPA Entity | åˆ›å»ºè§†å›¾å¯¹åº”çš„ Entity/DTO |
| `3.5.6_procedures.sql` | @Procedure æˆ– JdbcTemplate | Repository æˆ– Service |

---

## ğŸ’¾ Repository å±‚è°ƒç”¨ç¤ºä¾‹

### 1. è°ƒç”¨ä¸šåŠ¡æŸ¥è¯¢ï¼ˆ3.5.2ï¼‰

#### 1.1 åŸç”Ÿ SQL æŸ¥è¯¢ç¤ºä¾‹

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/tesla/rental/repository/VehicleRepository.java`

```java
package com.tesla.rental.repository;

import com.tesla.rental.entity.Vehicle;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface VehicleRepository extends JpaRepository<Vehicle, Integer> {
    
    // æŸ¥è¯¢ 1.1ï¼šåœ¨ç§ŸçŠ¶æ€è½¦è¾†æ¸…å•ï¼ˆ3.5.2 æŸ¥è¯¢1.1ï¼‰
    @Query(value = """
        SELECT v.vehicle_id, v.plate_no, cm.name AS model_name, 
               v.current_soc, v.current_mileage, s.name AS store_name
        FROM vehicle v
        JOIN car_model cm ON v.model_id = cm.model_id
        JOIN store s ON v.store_id = s.store_id
        WHERE v.status = 1
        """, nativeQuery = true)
    List<Object[]> findRentingVehicles();
    
    // æŸ¥è¯¢ 1.2ï¼šç”µé‡ä½äº 20% çš„è½¦è¾†æ¸…å•ï¼ˆ3.5.2 æŸ¥è¯¢1.2ï¼‰
    @Query(value = """
        SELECT v.vehicle_id, v.plate_no, cm.name AS model_name,
               v.current_soc, s.name AS store_name,
               CASE v.status
                   WHEN 0 THEN 'åœ¨åº“'
                   WHEN 1 THEN 'åœ¨ç§Ÿ'
                   WHEN 2 THEN 'ç»´ä¿'
               END AS status_desc
        FROM vehicle v
        JOIN car_model cm ON v.model_id = cm.model_id
        JOIN store s ON v.store_id = s.store_id
        WHERE v.current_soc < 20
        """, nativeQuery = true)
    List<Object[]> findLowBatteryVehicles();
    
    // æŸ¥è¯¢ 1.3ï¼šé«˜é‡Œç¨‹è½¦è¾†æ¸…å•ï¼ˆ3.5.2 æŸ¥è¯¢1.3ï¼‰
    @Query("SELECT v FROM Vehicle v WHERE v.currentMileage > :mileage ORDER BY v.currentMileage DESC")
    List<Vehicle> findHighMileageVehicles(@Param("mileage") Double mileage);
    
    // æŸ¥è¯¢ 4.1ï¼šè½¦ç‰Œæ¨¡ç³Šæœç´¢ï¼ˆ3.5.2 æŸ¥è¯¢4.1ï¼‰
    @Query("SELECT v FROM Vehicle v WHERE v.plateNo LIKE %:keyword%")
    List<Vehicle> searchByPlateNo(@Param("keyword") String keyword);
}
```

#### 1.2 å¤æ‚æŸ¥è¯¢ç¤ºä¾‹

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/tesla/rental/repository/RentalOrderRepository.java`

```java
package com.tesla.rental.repository;

import com.tesla.rental.entity.RentalOrder;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;

@Repository
public interface RentalOrderRepository extends JpaRepository<RentalOrder, Integer> {
    
    // æŸ¥è¯¢ 3.1ï¼šæœ¬æœˆç§Ÿé‡‘æ”¶å…¥ç»Ÿè®¡ï¼ˆ3.5.2 æŸ¥è¯¢3.1ï¼‰
    @Query(value = """
        SELECT SUM(p.amount) AS monthly_income, 
               COUNT(DISTINCT p.order_id) AS order_count,
               COUNT(*) AS payment_count
        FROM payment p
        JOIN rental_order ro ON p.order_id = ro.order_id
        WHERE p.type = 1 
          AND ro.rent_start BETWEEN :startDate AND :endDate
        """, nativeQuery = true)
    Object[] getMonthlyIncome(@Param("startDate") LocalDateTime startDate, 
                              @Param("endDate") LocalDateTime endDate);
    
    // æŸ¥è¯¢ 3.2ï¼šè¿‘ä¸€å‘¨å†…åˆ›å»ºçš„è®¢å•ï¼ˆ3.5.2 æŸ¥è¯¢3.2ï¼‰
    @Query(value = """
        SELECT ro.order_id, c.name AS customer_name, v.plate_no,
               ro.rent_start, ro.rent_end, ro.total_amount,
               CASE ro.status
                   WHEN 0 THEN 'å·²æ”¯ä»˜'
                   WHEN 1 THEN 'åœ¨ç§Ÿ'
                   WHEN 2 THEN 'å·²è¿˜'
                   WHEN 3 THEN 'ç»“ç®—'
               END AS status_desc
        FROM rental_order ro
        JOIN customer c ON ro.customer_id = c.customer_id
        JOIN vehicle v ON ro.vehicle_id = v.vehicle_id
        WHERE ro.rent_start BETWEEN DATE_SUB(CURDATE(), INTERVAL 7 DAY) AND CURDATE()
        """, nativeQuery = true)
    List<Object[]> findRecentOrders();
    
    // æŸ¥è¯¢ 5.1ï¼šè®¢å•å®Œæ•´ä¿¡æ¯æŸ¥è¯¢ï¼ˆ3.5.2 æŸ¥è¯¢5.1ï¼‰
    @Query(value = """
        SELECT ro.order_id, c.name, c.phone, v.plate_no, cm.name,
               ps.name AS pickup_store, rs.name AS return_store,
               ro.rent_start, ro.rent_end, ro.total_amount,
               COALESCE(SUM(p.amount), 0) AS paid_amount,
               CASE ro.status
                   WHEN 0 THEN 'å·²æ”¯ä»˜' WHEN 1 THEN 'åœ¨ç§Ÿ'
                   WHEN 2 THEN 'å·²è¿˜' WHEN 3 THEN 'ç»“ç®—'
               END AS status
        FROM rental_order ro
        JOIN customer c ON ro.customer_id = c.customer_id
        JOIN vehicle v ON ro.vehicle_id = v.vehicle_id
        JOIN car_model cm ON v.model_id = cm.model_id
        JOIN store ps ON ro.pickup_store_id = ps.store_id
        JOIN store rs ON ro.return_store_id = rs.store_id
        LEFT JOIN payment p ON ro.order_id = p.order_id
        WHERE ro.order_id = :orderId
        GROUP BY ro.order_id, c.name, c.phone, v.plate_no, cm.name,
                 ps.name, rs.name, ro.rent_start, ro.rent_end, 
                 ro.total_amount, ro.status
        """, nativeQuery = true)
    Object[] getOrderFullDetails(@Param("orderId") Integer orderId);
}
```

### 2. è°ƒç”¨ä¸šåŠ¡è§†å›¾ï¼ˆ3.5.4ï¼‰

#### 2.1 åˆ›å»ºè§†å›¾å¯¹åº”çš„ DTO

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/tesla/rental/dto/ActiveOrderView.java`

```java
package com.tesla.rental.dto;

import lombok.Data;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
public class ActiveOrderView {
    private Integer orderId;
    private LocalDateTime rentStart;
    private LocalDateTime rentEnd;
    private BigDecimal pickupSoc;
    private BigDecimal totalAmount;
    private Integer orderStatus;
    private String orderStatusDesc;
    private Integer rentalDays;
    
    // è½¦è¾†ä¿¡æ¯
    private Integer vehicleId;
    private String plateNo;
    private String carModelName;
    private Integer seatCount;
    
    // å®¢æˆ·ä¿¡æ¯
    private Integer customerId;
    private String customerName;
    private String customerPhone;
    
    // é—¨åº—ä¿¡æ¯
    private String pickupStoreName;
    private String returnStoreName;
    
    // ç§ŸæœŸçŠ¶æ€
    private String rentalPeriodStatus;
    private Integer daysRemaining;
}
```

#### 2.2 è§†å›¾æŸ¥è¯¢ Repository

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/tesla/rental/repository/ViewRepository.java` (æ–°å¢)

```java
package com.tesla.rental.repository;

import com.tesla.rental.dto.ActiveOrderView;
import com.tesla.rental.dto.StoreUtilizationView;
import com.tesla.rental.dto.CustomerValueView;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface ViewRepository {
    
    // è°ƒç”¨è§†å›¾ 1: vw_active_ordersï¼ˆåœ¨ç§Ÿè®¢å•è¯¦æƒ…ï¼‰
    @Query(value = "SELECT * FROM vw_active_orders", nativeQuery = true)
    List<Object[]> findAllActiveOrders();
    
    @Query(value = "SELECT * FROM vw_active_orders WHERE customer_id = :customerId", 
           nativeQuery = true)
    List<Object[]> findActiveOrdersByCustomer(@Param("customerId") Integer customerId);
    
    // è°ƒç”¨è§†å›¾ 2: vw_store_utilizationï¼ˆé—¨åº—è½¦è¾†åˆ©ç”¨ç‡ï¼‰
    @Query(value = "SELECT * FROM vw_store_utilization ORDER BY utilization_rate DESC", 
           nativeQuery = true)
    List<Object[]> findStoreUtilization();
    
    // è°ƒç”¨è§†å›¾ 3: vw_customer_valueï¼ˆå®¢æˆ·ä»·å€¼ç»Ÿè®¡ï¼‰
    @Query(value = "SELECT * FROM vw_customer_value WHERE customer_level = 'VIP'", 
           nativeQuery = true)
    List<Object[]> findVIPCustomers();
    
    @Query(value = """
        SELECT * FROM vw_customer_value 
        WHERE total_order_amount > :minAmount 
        ORDER BY total_order_amount DESC
        """, nativeQuery = true)
    List<Object[]> findHighValueCustomers(@Param("minAmount") Double minAmount);
    
    // è°ƒç”¨è§†å›¾ 4: vw_payment_summaryï¼ˆè®¢å•æ”¯ä»˜æ±‡æ€»ï¼‰
    @Query(value = "SELECT * FROM vw_payment_summary WHERE order_id = :orderId", 
           nativeQuery = true)
    Object[] getPaymentSummary(@Param("orderId") Integer orderId);
    
    // è°ƒç”¨è§†å›¾ 5: vw_maintenance_pendingï¼ˆå¾…å¤„ç†ç»´ä¿æé†’ï¼‰
    @Query(value = """
        SELECT * FROM vw_maintenance_pending 
        WHERE maint_priority IN ('é«˜ä¼˜å…ˆçº§', 'ä¸­ä¼˜å…ˆçº§')
        ORDER BY current_mileage DESC
        """, nativeQuery = true)
    List<Object[]> findPendingMaintenance();
    
    // è°ƒç”¨è§†å›¾ 6: vw_vehicle_detailsï¼ˆè½¦è¾†è¯¦ç»†ä¿¡æ¯ï¼‰
    @Query(value = """
        SELECT * FROM vw_vehicle_details 
        WHERE status = 0 AND store_id = :storeId
        """, nativeQuery = true)
    List<Object[]> findAvailableVehiclesByStore(@Param("storeId") Integer storeId);
    
    // è°ƒç”¨è§†å›¾ 7: vw_violation_summaryï¼ˆè¿ç« æ±‡æ€»ç»Ÿè®¡ï¼‰
    @Query(value = """
        SELECT * FROM vw_violation_summary 
        WHERE fine_amount > :minFine 
        ORDER BY fine_amount DESC
        """, nativeQuery = true)
    List<Object[]> findSeriousViolations(@Param("minFine") Double minFine);
}
```

### 3. è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ï¼ˆ3.5.6ï¼‰

#### 3.1 ä½¿ç”¨ JdbcTemplate è°ƒç”¨å­˜å‚¨è¿‡ç¨‹

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/tesla/rental/service/ProcedureService.java` (æ–°å¢)

```java
package com.tesla.rental.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.SqlOutParameter;
import org.springframework.jdbc.core.SqlParameter;
import org.springframework.jdbc.core.simple.SimpleJdbcCall;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.sql.Types;
import java.time.LocalDateTime;
import java.util.Map;

@Slf4j
@Service
@RequiredArgsConstructor
public class ProcedureService {
    
    private final JdbcTemplate jdbcTemplate;
    
    /**
     * è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ 1: sp_create_rental_orderï¼ˆåˆ›å»ºç§Ÿèµè®¢å•ï¼‰
     */
    public Map<String, Object> createRentalOrder(
            Integer customerId,
            Integer vehicleId,
            LocalDateTime rentStart,
            LocalDateTime rentEnd,
            Integer pickupStoreId,
            Integer returnStoreId,
            BigDecimal totalAmount
    ) {
        SimpleJdbcCall jdbcCall = new SimpleJdbcCall(jdbcTemplate)
            .withProcedureName("sp_create_rental_order")
            .declareParameters(
                new SqlParameter("p_customer_id", Types.INTEGER),
                new SqlParameter("p_vehicle_id", Types.INTEGER),
                new SqlParameter("p_rent_start", Types.TIMESTAMP),
                new SqlParameter("p_rent_end", Types.TIMESTAMP),
                new SqlParameter("p_pickup_store_id", Types.INTEGER),
                new SqlParameter("p_return_store_id", Types.INTEGER),
                new SqlParameter("p_total_amount", Types.DECIMAL),
                new SqlOutParameter("p_order_id", Types.INTEGER),
                new SqlOutParameter("p_result_code", Types.INTEGER),
                new SqlOutParameter("p_result_msg", Types.VARCHAR)
            );
        
        Map<String, Object> inParams = Map.of(
            "p_customer_id", customerId,
            "p_vehicle_id", vehicleId,
            "p_rent_start", rentStart,
            "p_rent_end", rentEnd,
            "p_pickup_store_id", pickupStoreId,
            "p_return_store_id", returnStoreId,
            "p_total_amount", totalAmount
        );
        
        Map<String, Object> result = jdbcCall.execute(inParams);
        
        log.info("åˆ›å»ºè®¢å•ç»“æœ: orderId={}, code={}, msg={}", 
                 result.get("p_order_id"), 
                 result.get("p_result_code"), 
                 result.get("p_result_msg"));
        
        return result;
    }
    
    /**
     * è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ 2: sp_settle_rental_orderï¼ˆè®¢å•ç»“ç®—ï¼‰
     */
    public Map<String, Object> settleRentalOrder(
            Integer orderId,
            BigDecimal returnSoc,
            LocalDateTime actualReturnTime,
            BigDecimal penaltyAmount
    ) {
        SimpleJdbcCall jdbcCall = new SimpleJdbcCall(jdbcTemplate)
            .withProcedureName("sp_settle_rental_order")
            .declareParameters(
                new SqlParameter("p_order_id", Types.INTEGER),
                new SqlParameter("p_return_soc", Types.DECIMAL),
                new SqlParameter("p_actual_return_time", Types.TIMESTAMP),
                new SqlParameter("p_penalty_amount", Types.DECIMAL),
                new SqlOutParameter("p_final_amount", Types.DECIMAL),
                new SqlOutParameter("p_refund_deposit", Types.DECIMAL),
                new SqlOutParameter("p_result_code", Types.INTEGER),
                new SqlOutParameter("p_result_msg", Types.VARCHAR)
            );
        
        Map<String, Object> inParams = Map.of(
            "p_order_id", orderId,
            "p_return_soc", returnSoc,
            "p_actual_return_time", actualReturnTime,
            "p_penalty_amount", penaltyAmount != null ? penaltyAmount : BigDecimal.ZERO
        );
        
        Map<String, Object> result = jdbcCall.execute(inParams);
        
        log.info("è®¢å•ç»“ç®—ç»“æœ: finalAmount={}, refundDeposit={}, msg={}", 
                 result.get("p_final_amount"),
                 result.get("p_refund_deposit"),
                 result.get("p_result_msg"));
        
        return result;
    }
    
    /**
     * è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ 3: sp_transfer_vehicleï¼ˆè½¦è¾†è°ƒæ‹¨ï¼‰
     */
    public Map<String, Object> transferVehicle(
            Integer vehicleId,
            Integer fromStoreId,
            Integer toStoreId,
            Integer operatorUserId,
            String reason
    ) {
        SimpleJdbcCall jdbcCall = new SimpleJdbcCall(jdbcTemplate)
            .withProcedureName("sp_transfer_vehicle")
            .declareParameters(
                new SqlParameter("p_vehicle_id", Types.INTEGER),
                new SqlParameter("p_from_store_id", Types.INTEGER),
                new SqlParameter("p_to_store_id", Types.INTEGER),
                new SqlParameter("p_operator_user_id", Types.INTEGER),
                new SqlParameter("p_reason", Types.VARCHAR),
                new SqlOutParameter("p_result_code", Types.INTEGER),
                new SqlOutParameter("p_result_msg", Types.VARCHAR)
            );
        
        Map<String, Object> inParams = Map.of(
            "p_vehicle_id", vehicleId,
            "p_from_store_id", fromStoreId,
            "p_to_store_id", toStoreId,
            "p_operator_user_id", operatorUserId,
            "p_reason", reason
        );
        
        Map<String, Object> result = jdbcCall.execute(inParams);
        
        log.info("è½¦è¾†è°ƒæ‹¨ç»“æœ: code={}, msg={}", 
                 result.get("p_result_code"),
                 result.get("p_result_msg"));
        
        return result;
    }
    
    /**
     * è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ 4: sp_update_customer_creditï¼ˆå®¢æˆ·ä¿¡ç”¨åˆ†æ›´æ–°ï¼‰
     */
    public Map<String, Object> updateCustomerCredit(Integer customerId) {
        SimpleJdbcCall jdbcCall = new SimpleJdbcCall(jdbcTemplate)
            .withProcedureName("sp_update_customer_credit")
            .declareParameters(
                new SqlParameter("p_customer_id", Types.INTEGER),
                new SqlOutParameter("p_old_credit", Types.INTEGER),
                new SqlOutParameter("p_new_credit", Types.INTEGER),
                new SqlOutParameter("p_deduction_reason", Types.VARCHAR),
                new SqlOutParameter("p_result_code", Types.INTEGER),
                new SqlOutParameter("p_result_msg", Types.VARCHAR)
            );
        
        Map<String, Object> result = jdbcCall.execute(Map.of("p_customer_id", customerId));
        
        log.info("ä¿¡ç”¨åˆ†æ›´æ–°: oldCredit={}, newCredit={}, reason={}", 
                 result.get("p_old_credit"),
                 result.get("p_new_credit"),
                 result.get("p_deduction_reason"));
        
        return result;
    }
    
    /**
     * è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ 5: sp_register_maintenanceï¼ˆç»´ä¿ç™»è®°ï¼‰
     */
    public Map<String, Object> registerMaintenance(
            Integer vehicleId,
            Integer maintType,
            String description,
            Integer operatorUserId
    ) {
        SimpleJdbcCall jdbcCall = new SimpleJdbcCall(jdbcTemplate)
            .withProcedureName("sp_register_maintenance")
            .declareParameters(
                new SqlParameter("p_vehicle_id", Types.INTEGER),
                new SqlParameter("p_maint_type", Types.INTEGER),
                new SqlParameter("p_description", Types.VARCHAR),
                new SqlParameter("p_operator_user_id", Types.INTEGER),
                new SqlOutParameter("p_maint_id", Types.INTEGER),
                new SqlOutParameter("p_next_maint_km", Types.DECIMAL),
                new SqlOutParameter("p_result_code", Types.INTEGER),
                new SqlOutParameter("p_result_msg", Types.VARCHAR)
            );
        
        Map<String, Object> inParams = Map.of(
            "p_vehicle_id", vehicleId,
            "p_maint_type", maintType,
            "p_description", description,
            "p_operator_user_id", operatorUserId
        );
        
        Map<String, Object> result = jdbcCall.execute(inParams);
        
        log.info("ç»´ä¿ç™»è®°: maintId={}, nextMaintKm={}, msg={}", 
                 result.get("p_maint_id"),
                 result.get("p_next_maint_km"),
                 result.get("p_result_msg"));
        
        return result;
    }
}
```

---

## ğŸ® Controller å±‚è°ƒç”¨ç¤ºä¾‹

### 1. æŸ¥è¯¢æ§åˆ¶å™¨ç¤ºä¾‹

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/tesla/rental/controller/QueryDemoController.java` (æ–°å¢)

```java
package com.tesla.rental.controller;

import com.tesla.rental.repository.VehicleRepository;
import com.tesla.rental.repository.RentalOrderRepository;
import com.tesla.rental.repository.ViewRepository;
import com.tesla.rental.service.ProcedureService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

/**
 * æŸ¥è¯¢æ¼”ç¤ºæ§åˆ¶å™¨ - ç”¨äºéªŒæ”¶ 3.5.2/3.5.4/3.5.6
 */
@Slf4j
@RestController
@RequestMapping("/api/demo")
@RequiredArgsConstructor
public class QueryDemoController {
    
    private final VehicleRepository vehicleRepository;
    private final RentalOrderRepository rentalOrderRepository;
    private final ViewRepository viewRepository;
    private final ProcedureService procedureService;
    
    // ========================================
    // 3.5.2 ä¸šåŠ¡æŸ¥è¯¢æ¼”ç¤º
    // ========================================
    
    /**
     * æŸ¥è¯¢åœ¨ç§Ÿè½¦è¾†ï¼ˆ3.5.2 æŸ¥è¯¢ 1.1ï¼‰
     * æƒé™: staff, auditor, admin
     */
    @GetMapping("/queries/renting-vehicles")
    @PreAuthorize("hasAnyRole('STAFF', 'AUDITOR', 'ADMIN')")
    public List<Object[]> getRentingVehicles() {
        log.info("æ‰§è¡ŒæŸ¥è¯¢: åœ¨ç§ŸçŠ¶æ€è½¦è¾†æ¸…å•");
        return vehicleRepository.findRentingVehicles();
    }
    
    /**
     * æŸ¥è¯¢ä½ç”µé‡è½¦è¾†ï¼ˆ3.5.2 æŸ¥è¯¢ 1.2ï¼‰
     * æƒé™: staff, admin
     */
    @GetMapping("/queries/low-battery-vehicles")
    @PreAuthorize("hasAnyRole('STAFF', 'ADMIN')")
    public List<Object[]> getLowBatteryVehicles() {
        log.info("æ‰§è¡ŒæŸ¥è¯¢: ç”µé‡ä½äº20%çš„è½¦è¾†æ¸…å•");
        return vehicleRepository.findLowBatteryVehicles();
    }
    
    /**
     * è½¦ç‰Œæ¨¡ç³Šæœç´¢ï¼ˆ3.5.2 æŸ¥è¯¢ 4.1ï¼‰
     * æƒé™: staff, auditor, admin
     */
    @GetMapping("/queries/search-vehicles")
    @PreAuthorize("hasAnyRole('STAFF', 'AUDITOR', 'ADMIN')")
    public List findVehiclesByPlate(@RequestParam String keyword) {
        log.info("æ‰§è¡ŒæŸ¥è¯¢: è½¦ç‰Œæ¨¡ç³Šæœç´¢ - {}", keyword);
        return vehicleRepository.searchByPlateNo(keyword);
    }
    
    /**
     * æœ¬æœˆæ”¶å…¥ç»Ÿè®¡ï¼ˆ3.5.2 æŸ¥è¯¢ 3.1ï¼‰
     * æƒé™: auditor, admin
     */
    @GetMapping("/queries/monthly-income")
    @PreAuthorize("hasAnyRole('AUDITOR', 'ADMIN')")
    public Object[] getMonthlyIncome() {
        log.info("æ‰§è¡ŒæŸ¥è¯¢: æœ¬æœˆç§Ÿé‡‘æ”¶å…¥ç»Ÿè®¡");
        LocalDateTime startDate = LocalDateTime.now().withDayOfMonth(1).withHour(0).withMinute(0).withSecond(0);
        LocalDateTime endDate = LocalDateTime.now().withHour(23).withMinute(59).withSecond(59);
        return rentalOrderRepository.getMonthlyIncome(startDate, endDate);
    }
    
    /**
     * è®¢å•å®Œæ•´ä¿¡æ¯ï¼ˆ3.5.2 æŸ¥è¯¢ 5.1ï¼‰
     * æƒé™: staff, auditor, admin
     */
    @GetMapping("/queries/order-details/{orderId}")
    @PreAuthorize("hasAnyRole('STAFF', 'AUDITOR', 'ADMIN')")
    public Object[] getOrderDetails(@PathVariable Integer orderId) {
        log.info("æ‰§è¡ŒæŸ¥è¯¢: è®¢å•å®Œæ•´ä¿¡æ¯ - orderId={}", orderId);
        return rentalOrderRepository.getOrderFullDetails(orderId);
    }
    
    // ========================================
    // 3.5.4 è§†å›¾æŸ¥è¯¢æ¼”ç¤º
    // ========================================
    
    /**
     * æŸ¥è¯¢æ‰€æœ‰åœ¨ç§Ÿè®¢å•ï¼ˆè§†å›¾ vw_active_ordersï¼‰
     * æƒé™: staff, auditor, admin
     */
    @GetMapping("/views/active-orders")
    @PreAuthorize("hasAnyRole('STAFF', 'AUDITOR', 'ADMIN')")
    public List<Object[]> getActiveOrders() {
        log.info("æ‰§è¡Œè§†å›¾æŸ¥è¯¢: vw_active_orders");
        return viewRepository.findAllActiveOrders();
    }
    
    /**
     * æŸ¥è¯¢é—¨åº—åˆ©ç”¨ç‡ï¼ˆè§†å›¾ vw_store_utilizationï¼‰
     * æƒé™: auditor, admin
     */
    @GetMapping("/views/store-utilization")
    @PreAuthorize("hasAnyRole('AUDITOR', 'ADMIN')")
    public List<Object[]> getStoreUtilization() {
        log.info("æ‰§è¡Œè§†å›¾æŸ¥è¯¢: vw_store_utilization");
        return viewRepository.findStoreUtilization();
    }
    
    /**
     * æŸ¥è¯¢VIPå®¢æˆ·ï¼ˆè§†å›¾ vw_customer_valueï¼‰
     * æƒé™: auditor, admin
     */
    @GetMapping("/views/vip-customers")
    @PreAuthorize("hasAnyRole('AUDITOR', 'ADMIN')")
    public List<Object[]> getVIPCustomers() {
        log.info("æ‰§è¡Œè§†å›¾æŸ¥è¯¢: vw_customer_value (VIP)");
        return viewRepository.findVIPCustomers();
    }
    
    /**
     * æŸ¥è¯¢æ”¯ä»˜æ±‡æ€»ï¼ˆè§†å›¾ vw_payment_summaryï¼‰
     * æƒé™: staff, auditor, admin
     */
    @GetMapping("/views/payment-summary/{orderId}")
    @PreAuthorize("hasAnyRole('STAFF', 'AUDITOR', 'ADMIN')")
    public Object[] getPaymentSummary(@PathVariable Integer orderId) {
        log.info("æ‰§è¡Œè§†å›¾æŸ¥è¯¢: vw_payment_summary - orderId={}", orderId);
        return viewRepository.getPaymentSummary(orderId);
    }
    
    /**
     * æŸ¥è¯¢å¾…ç»´ä¿è½¦è¾†ï¼ˆè§†å›¾ vw_maintenance_pendingï¼‰
     * æƒé™: staff, admin
     */
    @GetMapping("/views/pending-maintenance")
    @PreAuthorize("hasAnyRole('STAFF', 'ADMIN')")
    public List<Object[]> getPendingMaintenance() {
        log.info("æ‰§è¡Œè§†å›¾æŸ¥è¯¢: vw_maintenance_pending");
        return viewRepository.findPendingMaintenance();
    }
    
    /**
     * æŸ¥è¯¢ä¸¥é‡è¿ç« ï¼ˆè§†å›¾ vw_violation_summaryï¼‰
     * æƒé™: auditor, admin
     */
    @GetMapping("/views/serious-violations")
    @PreAuthorize("hasAnyRole('AUDITOR', 'ADMIN')")
    public List<Object[]> getSeriousViolations(@RequestParam(defaultValue = "500") Double minFine) {
        log.info("æ‰§è¡Œè§†å›¾æŸ¥è¯¢: vw_violation_summary - minFine={}", minFine);
        return viewRepository.findSeriousViolations(minFine);
    }
    
    // ========================================
    // 3.5.6 å­˜å‚¨è¿‡ç¨‹è°ƒç”¨æ¼”ç¤º
    // ========================================
    
    /**
     * åˆ›å»ºç§Ÿèµè®¢å•ï¼ˆå­˜å‚¨è¿‡ç¨‹ sp_create_rental_orderï¼‰
     * æƒé™: staff, admin
     */
    @PostMapping("/procedures/create-order")
    @PreAuthorize("hasAnyRole('STAFF', 'ADMIN')")
    public Map<String, Object> createOrder(@RequestBody Map<String, Object> params) {
        log.info("è°ƒç”¨å­˜å‚¨è¿‡ç¨‹: sp_create_rental_order");
        return procedureService.createRentalOrder(
            (Integer) params.get("customerId"),
            (Integer) params.get("vehicleId"),
            LocalDateTime.parse((String) params.get("rentStart")),
            LocalDateTime.parse((String) params.get("rentEnd")),
            (Integer) params.get("pickupStoreId"),
            (Integer) params.get("returnStoreId"),
            new BigDecimal(params.get("totalAmount").toString())
        );
    }
    
    /**
     * è®¢å•ç»“ç®—ï¼ˆå­˜å‚¨è¿‡ç¨‹ sp_settle_rental_orderï¼‰
     * æƒé™: staff, admin
     */
    @PostMapping("/procedures/settle-order")
    @PreAuthorize("hasAnyRole('STAFF', 'ADMIN')")
    public Map<String, Object> settleOrder(@RequestBody Map<String, Object> params) {
        log.info("è°ƒç”¨å­˜å‚¨è¿‡ç¨‹: sp_settle_rental_order");
        return procedureService.settleRentalOrder(
            (Integer) params.get("orderId"),
            new BigDecimal(params.get("returnSoc").toString()),
            LocalDateTime.parse((String) params.get("actualReturnTime")),
            params.get("penaltyAmount") != null ? 
                new BigDecimal(params.get("penaltyAmount").toString()) : BigDecimal.ZERO
        );
    }
    
    /**
     * è½¦è¾†è°ƒæ‹¨ï¼ˆå­˜å‚¨è¿‡ç¨‹ sp_transfer_vehicleï¼‰
     * æƒé™: admin only
     */
    @PostMapping("/procedures/transfer-vehicle")
    @PreAuthorize("hasRole('ADMIN')")
    public Map<String, Object> transferVehicle(@RequestBody Map<String, Object> params) {
        log.info("è°ƒç”¨å­˜å‚¨è¿‡ç¨‹: sp_transfer_vehicle");
        return procedureService.transferVehicle(
            (Integer) params.get("vehicleId"),
            (Integer) params.get("fromStoreId"),
            (Integer) params.get("toStoreId"),
            (Integer) params.get("operatorUserId"),
            (String) params.get("reason")
        );
    }
    
    /**
     * æ›´æ–°å®¢æˆ·ä¿¡ç”¨åˆ†ï¼ˆå­˜å‚¨è¿‡ç¨‹ sp_update_customer_creditï¼‰
     * æƒé™: staff, admin
     */
    @PostMapping("/procedures/update-credit/{customerId}")
    @PreAuthorize("hasAnyRole('STAFF', 'ADMIN')")
    public Map<String, Object> updateCredit(@PathVariable Integer customerId) {
        log.info("è°ƒç”¨å­˜å‚¨è¿‡ç¨‹: sp_update_customer_credit");
        return procedureService.updateCustomerCredit(customerId);
    }
    
    /**
     * ç»´ä¿ç™»è®°ï¼ˆå­˜å‚¨è¿‡ç¨‹ sp_register_maintenanceï¼‰
     * æƒé™: staff, admin
     */
    @PostMapping("/procedures/register-maintenance")
    @PreAuthorize("hasAnyRole('STAFF', 'ADMIN')")
    public Map<String, Object> registerMaintenance(@RequestBody Map<String, Object> params) {
        log.info("è°ƒç”¨å­˜å‚¨è¿‡ç¨‹: sp_register_maintenance");
        return procedureService.registerMaintenance(
            (Integer) params.get("vehicleId"),
            (Integer) params.get("maintType"),
            (String) params.get("description"),
            (Integer) params.get("operatorUserId")
        );
    }
}
```

---

## ğŸ­ è§’è‰²æƒé™æ˜ å°„

### æ•°æ®åº“è§’è‰² â†” Spring Security è§’è‰²æ˜ å°„

| æ•°æ®åº“ç”¨æˆ· | Spring Security Role | sys_role.role_id | è¯´æ˜ |
|-----------|---------------------|-----------------|------|
| tesla_admin | ROLE_ADMIN | 1 | ç®¡ç†å‘˜ |
| tesla_staff | ROLE_STAFF | 2 | åº—å‘˜ |
| tesla_auditor | ROLE_AUDITOR | 3 | å®¡è®¡å‘˜ |

### åŠŸèƒ½æƒé™å¯¹ç…§è¡¨

#### 1. adminï¼ˆç®¡ç†å‘˜ï¼‰æƒé™

| åŠŸèƒ½åˆ†ç±» | å…·ä½“åŠŸèƒ½ | æ¥å£è·¯å¾„ | æƒé™æ³¨è§£ |
|---------|---------|---------|---------|
| **æŸ¥è¯¢åŠŸèƒ½** | æ‰€æœ‰ä¸šåŠ¡æŸ¥è¯¢ | `/api/demo/queries/**` | `@PreAuthorize("hasRole('ADMIN')")` |
| **è§†å›¾æŸ¥è¯¢** | æ‰€æœ‰è§†å›¾æŸ¥è¯¢ | `/api/demo/views/**` | `@PreAuthorize("hasRole('ADMIN')")` |
| **å­˜å‚¨è¿‡ç¨‹** | æ‰€æœ‰å­˜å‚¨è¿‡ç¨‹ | `/api/demo/procedures/**` | `@PreAuthorize("hasRole('ADMIN')")` |
| **è½¦è¾†ç®¡ç†** | è½¦è¾†è°ƒæ‹¨ | `POST /api/demo/procedures/transfer-vehicle` | `@PreAuthorize("hasRole('ADMIN')")` |
| **ç³»ç»Ÿç®¡ç†** | ç”¨æˆ·ç®¡ç†ã€æƒé™ç®¡ç† | å…¨éƒ¨ | `@PreAuthorize("hasRole('ADMIN')")` |

#### 2. staffï¼ˆåº—å‘˜ï¼‰æƒé™

| åŠŸèƒ½åˆ†ç±» | å…·ä½“åŠŸèƒ½ | æ¥å£è·¯å¾„ | æƒé™æ³¨è§£ |
|---------|---------|---------|---------|
| **è½¦è¾†æŸ¥è¯¢** | åœ¨ç§Ÿè½¦è¾†ã€ä½ç”µé‡è½¦è¾† | `GET /api/demo/queries/renting-vehicles` | `@PreAuthorize("hasAnyRole('STAFF','ADMIN')")` |
| **è®¢å•æŸ¥è¯¢** | è®¢å•è¯¦æƒ…ã€åœ¨ç§Ÿè®¢å• | `GET /api/demo/queries/order-details` | `@PreAuthorize("hasAnyRole('STAFF','AUDITOR','ADMIN')")` |
| **è®¢å•æ“ä½œ** | åˆ›å»ºè®¢å•ã€è®¢å•ç»“ç®— | `POST /api/demo/procedures/create-order` | `@PreAuthorize("hasAnyRole('STAFF','ADMIN')")` |
| **å®¢æˆ·ç®¡ç†** | æ›´æ–°ä¿¡ç”¨åˆ† | `POST /api/demo/procedures/update-credit` | `@PreAuthorize("hasAnyRole('STAFF','ADMIN')")` |
| **ç»´ä¿ç®¡ç†** | ç»´ä¿ç™»è®°ã€æŸ¥è¯¢å¾…ç»´ä¿ | `POST /api/demo/procedures/register-maintenance` | `@PreAuthorize("hasAnyRole('STAFF','ADMIN')")` |
| **è§†å›¾æŸ¥è¯¢** | åœ¨ç§Ÿè®¢å•ã€æ”¯ä»˜æ±‡æ€» | `GET /api/demo/views/active-orders` | `@PreAuthorize("hasAnyRole('STAFF','AUDITOR','ADMIN')")` |
| âŒ **ç¦æ­¢** | è½¦è¾†è°ƒæ‹¨ | - | ä»… admin |
| âŒ **ç¦æ­¢** | æ”¶å…¥ç»Ÿè®¡ã€VIPå®¢æˆ· | - | ä»… auditor/admin |

#### 3. auditorï¼ˆå®¡è®¡å‘˜ï¼‰æƒé™

| åŠŸèƒ½åˆ†ç±» | å…·ä½“åŠŸèƒ½ | æ¥å£è·¯å¾„ | æƒé™æ³¨è§£ |
|---------|---------|---------|---------|
| **æŸ¥è¯¢åŠŸèƒ½** | æ‰€æœ‰åªè¯»æŸ¥è¯¢ | `GET /api/demo/queries/**` | `@PreAuthorize("hasAnyRole('AUDITOR','ADMIN')")` |
| **è§†å›¾æŸ¥è¯¢** | æ‰€æœ‰è§†å›¾ï¼ˆåªè¯»ï¼‰ | `GET /api/demo/views/**` | `@PreAuthorize("hasAnyRole('AUDITOR','ADMIN')")` |
| **è´¢åŠ¡æŸ¥è¯¢** | æ”¶å…¥ç»Ÿè®¡ã€æ”¯ä»˜æ±‡æ€» | `GET /api/demo/queries/monthly-income` | `@PreAuthorize("hasAnyRole('AUDITOR','ADMIN')")` |
| **å®¢æˆ·åˆ†æ** | VIPå®¢æˆ·ã€é«˜ä»·å€¼å®¢æˆ· | `GET /api/demo/views/vip-customers` | `@PreAuthorize("hasAnyRole('AUDITOR','ADMIN')")` |
| **è¿ç« æŸ¥è¯¢** | ä¸¥é‡è¿ç« ç»Ÿè®¡ | `GET /api/demo/views/serious-violations` | `@PreAuthorize("hasAnyRole('AUDITOR','ADMIN')")` |
| **è¿è¥åˆ†æ** | é—¨åº—åˆ©ç”¨ç‡ | `GET /api/demo/views/store-utilization` | `@PreAuthorize("hasAnyRole('AUDITOR','ADMIN')")` |
| âŒ **ç¦æ­¢** | æ‰€æœ‰å†™æ“ä½œ | `POST/PUT/DELETE` | å®Œå…¨åªè¯» |
| âŒ **ç¦æ­¢** | å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œ | `POST /api/demo/procedures/**` | æ— æƒé™ |

---

## ğŸ”’ å®‰å…¨é…ç½®ç¤ºä¾‹

### Spring Security é…ç½®

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/tesla/rental/security/SecurityConfig.java`

```java
package com.tesla.rental.security;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
@EnableMethodSecurity(prePostEnabled = true)
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                // å…¬å¼€æ¥å£
                .requestMatchers("/api/auth/**").permitAll()
                
                // æ¼”ç¤ºæ¥å£ - æŒ‰è§’è‰²æ§åˆ¶
                .requestMatchers("/api/demo/queries/**").hasAnyRole("STAFF", "AUDITOR", "ADMIN")
                .requestMatchers("/api/demo/views/**").hasAnyRole("STAFF", "AUDITOR", "ADMIN")
                .requestMatchers("/api/demo/procedures/**").hasAnyRole("STAFF", "ADMIN")
                
                // ç®¡ç†æ¥å£ - ä»…ç®¡ç†å‘˜
                .requestMatchers("/api/admin/**").hasRole("ADMIN")
                
                // å…¶ä»–æ¥å£éœ€è¦è®¤è¯
                .anyRequest().authenticated()
            )
            .csrf(csrf -> csrf.disable())
            .httpBasic(basic -> {});
        
        return http.build();
    }
}
```

### è§’è‰²æ£€æŸ¥å·¥å…·ç±»

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/tesla/rental/util/RoleChecker.java` (æ–°å¢)

```java
package com.tesla.rental.util;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

@Component
public class RoleChecker {
    
    public boolean hasRole(String role) {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        if (auth == null) return false;
        
        return auth.getAuthorities().stream()
            .map(GrantedAuthority::getAuthority)
            .anyMatch(r -> r.equals("ROLE_" + role));
    }
    
    public boolean isAdmin() {
        return hasRole("ADMIN");
    }
    
    public boolean isStaff() {
        return hasRole("STAFF");
    }
    
    public boolean isAuditor() {
        return hasRole("AUDITOR");
    }
}
```

---

## ğŸ§ª æµ‹è¯•éªŒæ”¶

### CommandLineRunner æµ‹è¯•ç¤ºä¾‹

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/tesla/rental/runner/DatabaseTestRunner.java` (æ–°å¢)

```java
package com.tesla.rental.runner;

import com.tesla.rental.repository.VehicleRepository;
import com.tesla.rental.repository.ViewRepository;
import com.tesla.rental.service.ProcedureService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * æ•°æ®åº“åŠŸèƒ½æµ‹è¯• - å¯åŠ¨æ—¶è‡ªåŠ¨éªŒè¯
 * æ³¨æ„: ç”Ÿäº§ç¯å¢ƒéœ€ç¦ç”¨
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class DatabaseTestRunner implements CommandLineRunner {
    
    private final VehicleRepository vehicleRepository;
    private final ViewRepository viewRepository;
    private final ProcedureService procedureService;
    
    @Override
    public void run(String... args) {
        log.info("========== å¼€å§‹æ•°æ®åº“åŠŸèƒ½æµ‹è¯• ==========");
        
        // æµ‹è¯• 3.5.2 æŸ¥è¯¢
        testBusinessQueries();
        
        // æµ‹è¯• 3.5.4 è§†å›¾
        testViews();
        
        // æµ‹è¯• 3.5.6 å­˜å‚¨è¿‡ç¨‹
        // testProcedures();  // è°¨æ…ï¼šè¿™ä¼šä¿®æ”¹æ•°æ®
        
        log.info("========== æ•°æ®åº“åŠŸèƒ½æµ‹è¯•å®Œæˆ ==========");
    }
    
    private void testBusinessQueries() {
        log.info("\n--- æµ‹è¯• 3.5.2 ä¸šåŠ¡æŸ¥è¯¢ ---");
        
        // æŸ¥è¯¢ 1.1: åœ¨ç§Ÿè½¦è¾†
        List<Object[]> rentingVehicles = vehicleRepository.findRentingVehicles();
        log.info("âœ“ åœ¨ç§Ÿè½¦è¾†æ•°é‡: {}", rentingVehicles.size());
        
        // æŸ¥è¯¢ 1.2: ä½ç”µé‡è½¦è¾†
        List<Object[]> lowBatteryVehicles = vehicleRepository.findLowBatteryVehicles();
        log.info("âœ“ ä½ç”µé‡è½¦è¾†æ•°é‡: {}", lowBatteryVehicles.size());
        
        // æŸ¥è¯¢ 4.1: è½¦ç‰Œæœç´¢
        var searchResults = vehicleRepository.searchByPlateNo("A1");
        log.info("âœ“ è½¦ç‰Œæœç´¢ç»“æœ: {}", searchResults.size());
    }
    
    private void testViews() {
        log.info("\n--- æµ‹è¯• 3.5.4 è§†å›¾æŸ¥è¯¢ ---");
        
        // è§†å›¾ 1: åœ¨ç§Ÿè®¢å•
        List<Object[]> activeOrders = viewRepository.findAllActiveOrders();
        log.info("âœ“ vw_active_orders: {} æ¡è®°å½•", activeOrders.size());
        
        // è§†å›¾ 2: é—¨åº—åˆ©ç”¨ç‡
        List<Object[]> storeUtil = viewRepository.findStoreUtilization();
        log.info("âœ“ vw_store_utilization: {} æ¡è®°å½•", storeUtil.size());
        
        // è§†å›¾ 3: VIPå®¢æˆ·
        List<Object[]> vipCustomers = viewRepository.findVIPCustomers();
        log.info("âœ“ vw_customer_value (VIP): {} æ¡è®°å½•", vipCustomers.size());
        
        // è§†å›¾ 5: å¾…ç»´ä¿è½¦è¾†
        List<Object[]> pendingMaint = viewRepository.findPendingMaintenance();
        log.info("âœ“ vw_maintenance_pending: {} æ¡è®°å½•", pendingMaint.size());
    }
    
    // private void testProcedures() {
    //     log.info("\n--- æµ‹è¯• 3.5.6 å­˜å‚¨è¿‡ç¨‹ï¼ˆä»…æ¼”ç¤ºè°ƒç”¨ï¼Œä¸æ‰§è¡Œï¼‰---");
    //     // å®é™…è°ƒç”¨éœ€è°¨æ…ï¼Œè¿™é‡Œä»…æ¼”ç¤º
    //     log.info("âœ“ å­˜å‚¨è¿‡ç¨‹æ¥å£å·²å‡†å¤‡å°±ç»ª");
    // }
}
```

### Postman/cURL æµ‹è¯•ç¤ºä¾‹

```bash
# 1. æµ‹è¯•æŸ¥è¯¢åœ¨ç§Ÿè½¦è¾†ï¼ˆéœ€è¦ STAFF æˆ– ADMIN æƒé™ï¼‰
curl -X GET "http://localhost:8080/api/demo/queries/renting-vehicles" \
  -H "Authorization: Basic c3RhZmY6cGFzc3dvcmQ="

# 2. æµ‹è¯•è§†å›¾æŸ¥è¯¢ - VIPå®¢æˆ·ï¼ˆéœ€è¦ AUDITOR æˆ– ADMIN æƒé™ï¼‰
curl -X GET "http://localhost:8080/api/demo/views/vip-customers" \
  -H "Authorization: Basic YXVkaXRvcjpwYXNzd29yZA=="

# 3. æµ‹è¯•å­˜å‚¨è¿‡ç¨‹ - åˆ›å»ºè®¢å•ï¼ˆéœ€è¦ STAFF æˆ– ADMIN æƒé™ï¼‰
curl -X POST "http://localhost:8080/api/demo/procedures/create-order" \
  -H "Content-Type: application/json" \
  -H "Authorization: Basic c3RhZmY6cGFzc3dvcmQ=" \
  -d '{
    "customerId": 1,
    "vehicleId": 1,
    "rentStart": "2025-12-10T09:00:00",
    "rentEnd": "2025-12-15T18:00:00",
    "pickupStoreId": 1,
    "returnStoreId": 1,
    "totalAmount": 2500.00
  }'

# 4. æµ‹è¯•å­˜å‚¨è¿‡ç¨‹ - è½¦è¾†è°ƒæ‹¨ï¼ˆä»… ADMIN æƒé™ï¼‰
curl -X POST "http://localhost:8080/api/demo/procedures/transfer-vehicle" \
  -H "Content-Type: application/json" \
  -H "Authorization: Basic YWRtaW46cGFzc3dvcmQ=" \
  -d '{
    "vehicleId": 15,
    "fromStoreId": 2,
    "toStoreId": 1,
    "operatorUserId": 5,
    "reason": "åŒ—äº¬é—¨åº—è½¦è¾†ç´§å¼ "
  }'
```

---

## ğŸ“š æ€»ç»“

### å·²å®ç°åŠŸèƒ½æ¸…å•

âœ… **3.5.2 ä¸šåŠ¡æŸ¥è¯¢**ï¼šé€šè¿‡ Repository `@Query` æ³¨è§£è°ƒç”¨
âœ… **3.5.4 ä¸šåŠ¡è§†å›¾**ï¼šé€šè¿‡ ViewRepository ä¸“é—¨æ¥å£è°ƒç”¨
âœ… **3.5.6 å­˜å‚¨è¿‡ç¨‹**ï¼šé€šè¿‡ JdbcTemplate çš„ SimpleJdbcCall è°ƒç”¨

### Java ç±»å¼•ç”¨è·¯å¾„æ±‡æ€»

| åŠŸèƒ½ | ç±»è·¯å¾„ |
|-----|--------|
| è½¦è¾†æŸ¥è¯¢ | `com.tesla.rental.repository.VehicleRepository` |
| è®¢å•æŸ¥è¯¢ | `com.tesla.rental.repository.RentalOrderRepository` |
| è§†å›¾æŸ¥è¯¢ | `com.tesla.rental.repository.ViewRepository`ï¼ˆæ–°å¢ï¼‰ |
| å­˜å‚¨è¿‡ç¨‹è°ƒç”¨ | `com.tesla.rental.service.ProcedureService`ï¼ˆæ–°å¢ï¼‰ |
| æ¼”ç¤ºæ§åˆ¶å™¨ | `com.tesla.rental.controller.QueryDemoController`ï¼ˆæ–°å¢ï¼‰ |
| æµ‹è¯•è¿è¡Œå™¨ | `com.tesla.rental.runner.DatabaseTestRunner`ï¼ˆæ–°å¢ï¼‰ |
| å®‰å…¨é…ç½® | `com.tesla.rental.security.SecurityConfig` |

### è§’è‰²æƒé™æ€»ç»“

| è§’è‰² | æŸ¥è¯¢ | è§†å›¾ | å­˜å‚¨è¿‡ç¨‹ | è½¦è¾†è°ƒæ‹¨ | è´¢åŠ¡ç»Ÿè®¡ |
|------|-----|------|---------|---------|---------|
| **admin** | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… å…¨éƒ¨ | âœ… | âœ… |
| **staff** | âœ… éƒ¨åˆ† | âœ… éƒ¨åˆ† | âœ… éƒ¨åˆ† | âŒ | âŒ |
| **auditor** | âœ… åªè¯» | âœ… åªè¯» | âŒ | âŒ | âœ… |

---

## ğŸ“ è”ç³»å’Œæ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- æ•°æ®åº“è„šæœ¬ï¼š`docs/sql/3.5.2_queries.sql`ã€`3.5.4_views.sql`ã€`3.5.6_procedures.sql`
- å®‰å…¨é…ç½®ï¼š`docs/sql/3.5.8_security.sql`
- Java æºç ï¼š`src/main/java/com/tesla/rental/`

---

**æ–‡æ¡£ç»“æŸ** ğŸ‰
